---
const { record, sectionId = "places", title = "Places" } = Astro.props;
const locations = record["trial_locations"].map((location) => ({
  name: location.Location,
  desc: location["Relation to case"],
  lat: location.Latitude,
  long: location.Longitude,
}));
---

<section id={sectionId}>
  <header>{title}</header>
  <div class="location-rows">
    {locations.map((location) => (
      <div class="location-row" data-location={JSON.stringify(location)}>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 32 32"
          class="icon"
        >
          <path
            class="shadow"
            d="M16 32s1.427-9.585 3.761-12.025c4.595-4.805 8.685-.99 8.685-.99s4.044 3.964-.526 8.743C25.514 30.245 16 32 16 32z"
          />
          <path
            class="pin"
            d="M15.938 32S6 17.938 6 11.938C6 .125 15.938 0 15.938 0S26 .125 26 11.875C26 18.062 15.938 32 15.938 32zM16 6a4 4 0 100 8 4 4 0 000-8z"
          />
        </svg>
        <span class="location-name">{location.name}</span>
        <span class="location-desc">{location.desc}</span>
      </div>
    ))}
  </div>
  <div id="map"></div>
</section>

<script>
  import * as L from "leaflet/dist/leaflet-src.esm.js";

  const svgTemplate = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="marker">
      <path class="shadow" d="M16 32s1.427-9.585 3.761-12.025c4.595-4.805 8.685-.99 8.685-.99s4.044 3.964-.526 8.743C25.514 30.245 16 32 16 32z"/>
      <path class="pin" d="M15.938 32S6 17.938 6 11.938C6 .125 15.938 0 15.938 0S26 .125 26 11.875C26 18.062 15.938 32 15.938 32zM16 6a4 4 0 100 8 4 4 0 000-8z"/>
    </svg>`;

  const icon = L.divIcon({
    className: "marker",
    html: svgTemplate,
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -45],
  });

  const locations = document.querySelectorAll("[data-location]");
  const locationData = [...locations].map((location) =>
    JSON.parse(location.dataset.location),
  );

  if (locationData) {
    const map = L.map("map", { minZoom: 5, maxZoom: 12 }).fitBounds(
      [locationData.map((location) => [location.lat, location.long])],
      { maxZoom: 8 },
    );

    L.tileLayer(
      "https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png",
      {
        attribution:
          'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      },
    ).addTo(map);

    locations.forEach((location) => {
      const { lat, long, name, desc } = JSON.parse(location.dataset.location);
      const marker = L.marker([lat, long], { icon: icon });
      marker.addTo(map).bindPopup(`<header>${name}</header><p>${desc}</p>`);
      location.classList.add("clickable");
      location.addEventListener("click", () => map.setView([lat, long]));
      location.addEventListener("mouseover", () =>
        L.DomUtil.addClass(marker._icon, "highlight"),
      );
      location.addEventListener("mouseout", () =>
        L.DomUtil.removeClass(marker._icon, "highlight"),
      );
    });
  }
</script>

<style>
  #map {
    height: 400px;
    border-radius: var(--radius-2);
  }

  .location-rows {
    display: grid;
    gap: var(--size-3);
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    margin-bottom: var(--size-3);
  }

  .location-row {
    display: grid;
    gap: 0 var(--size-3);
    grid-template-columns: 50px 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas:
      "icon name"
      "icon desc";
  }

  .clickable {
    cursor: pointer;
  }

  .icon {
    grid-row: span 2;
    height: var(--size-9);
    overflow: visible;
  }

  .location-name {
    color: var(--palette-7);
    font-size: var(--font-size-3);
    font-weight: bold;
    padding-top: var(--size-2);
  }

  :global(svg.marker) {
    height: 100%;
    overflow: visible;
    width: 100%;
  }

  :global(path.pin) {
    fill: var(--palette-7);
    stroke: white;
    transition: fill 0.2s ease, transform 0.2s ease;
  }

  :global(.highlight path.pin, .clickable:hover path.pin) {
    fill: rebeccapurple;
    transform: translateY(-5px);
  }

  :global(path.shadow) {
    fill: initial;
    fill-opacity: 0.25;
    stroke: initial;
    transition: transform 0.2s ease;
  }

  :global(.highlight path.shadow, .clickable:hover path.shadow) {
    transform: translate(5px, -5px);
  }
</style><style is:global>
  @import "leaflet/dist/leaflet.css";
  @import "../styles/leaflet-overrides.css";
</style>
